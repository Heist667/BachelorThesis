var geometry = 
    /* color: #ffffff */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      }
    ] */
    ee.Geometry.Polygon(
        [[[7.379725307345084, 52.31173487029878],
          [7.379725307345084, 52.19719395437755],
          [7.568896144747428, 52.19719395437755],
          [7.568896144747428, 52.31173487029878]]], null, false),
    table = ee.FeatureCollection("FAO/GAUL/2015/level1"),
    imageCollection = ee.ImageCollection("COPERNICUS/S2_SR_HARMONIZED"),
    imageCollection2 = ee.ImageCollection("COPERNICUS/S1_GRD"),
    water = 
    /* color: #0f51ff */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[6.633411305206902, 51.83137288817917],
                  [6.633411305206902, 51.83031204614343],
                  [6.63521374966491, 51.83031204614343],
                  [6.63521374966491, 51.83137288817917]]], null, false),
            {
              "class": 0,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.635642903107293, 51.82914509104303],
                  [6.635642903107293, 51.82723546293229],
                  [6.638389485138543, 51.82723546293229],
                  [6.638389485138543, 51.82914509104303]]], null, false),
            {
              "class": 0,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.585346119660027, 51.82500746114149],
                  [6.585346119660027, 51.82437086896022],
                  [6.586547749298699, 51.82437086896022],
                  [6.586547749298699, 51.82500746114149]]], null, false),
            {
              "class": 0,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.584745304840691, 51.828190287107965],
                  [6.584745304840691, 51.827606785850186],
                  [6.585603611725457, 51.827606785850186],
                  [6.585603611725457, 51.828190287107965]]], null, false),
            {
              "class": 0,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.7147085643739945, 51.823213903678045],
                  [6.7147085643739945, 51.82262702221932],
                  [6.71582436332419, 51.82262702221932],
                  [6.71582436332419, 51.823213903678045]]], null, false),
            {
              "class": 0,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.721272007032764, 51.82768988411347],
                  [6.721272007032764, 51.8272588848077],
                  [6.725563541456592, 51.8272588848077],
                  [6.725563541456592, 51.82768988411347]]], null, false),
            {
              "class": 0,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.721969381376636, 51.82706659147929],
                  [6.721969381376636, 51.82657590823161],
                  [6.724673048063647, 51.82657590823161],
                  [6.724673048063647, 51.82706659147929]]], null, false),
            {
              "class": 0,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.801595832028786, 51.83881039118389],
                  [6.801595832028786, 51.83770994885473],
                  [6.8025614272741475, 51.83770994885473],
                  [6.8025614272741475, 51.83881039118389]]], null, false),
            {
              "class": 0,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.795973921933571, 51.836317784483],
                  [6.795973921933571, 51.83553550180488],
                  [6.7972184669164815, 51.83553550180488],
                  [6.7972184669164815, 51.836317784483]]], null, false),
            {
              "class": 0,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.790030146756569, 51.83447475782213],
                  [6.790030146756569, 51.834063712811705],
                  [6.79125323406736, 51.834063712811705],
                  [6.79125323406736, 51.83447475782213]]], null, false),
            {
              "class": 0,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.882600858605512, 51.83319225759484],
                  [6.882600858605512, 51.832695011090415],
                  [6.8843389300471625, 51.832695011090415],
                  [6.8843389300471625, 51.83319225759484]]], null, false),
            {
              "class": 0,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.648094545313442, 51.95080407173575],
                  [7.648094545313442, 51.950288286917775],
                  [7.649296174952114, 51.950288286917775],
                  [7.649296174952114, 51.95080407173575]]], null, false),
            {
              "class": 0,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.614093145628931, 51.956925357264275],
                  [7.614093145628931, 51.956158395224705],
                  [7.616989931365015, 51.956158395224705],
                  [7.616989931365015, 51.956925357264275]]], null, false),
            {
              "class": 0,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.611282190581323, 51.955748461857766],
                  [7.611282190581323, 51.954611207734175],
                  [7.6129988043508545, 51.954611207734175],
                  [7.6129988043508545, 51.955748461857766]]], null, false),
            {
              "class": 0,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.597408539241726, 51.94664731516704],
                  [7.597408539241726, 51.944451678768324],
                  [7.5992109836997335, 51.944451678768324],
                  [7.5992109836997335, 51.94664731516704]]], null, false),
            {
              "class": 0,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.7152568713295135, 51.468457072422794],
                  [6.7152568713295135, 51.46695994857366],
                  [6.71834677611467, 51.46695994857366],
                  [6.71834677611467, 51.468457072422794]]], null, false),
            {
              "class": 0,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.707446278678146, 51.46540930422937],
                  [6.707446278678146, 51.464232918196316],
                  [6.711651982413498, 51.464232918196316],
                  [6.711651982413498, 51.46540930422937]]], null, false),
            {
              "class": 0,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.721865834342209, 51.46204048148354],
                  [6.721865834342209, 51.456853077680165],
                  [6.7248699084388885, 51.456853077680165],
                  [6.7248699084388885, 51.46204048148354]]], null, false),
            {
              "class": 0,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.7115207601464055, 51.44491656338473],
                  [6.7115207601464055, 51.437801119139955],
                  [6.7128940511620305, 51.437801119139955],
                  [6.7128940511620305, 51.44491656338473]]], null, false),
            {
              "class": 0,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.743620077436168, 51.40761188918259],
                  [6.743620077436168, 51.396849263074735],
                  [6.746023336713511, 51.396849263074735],
                  [6.746023336713511, 51.40761188918259]]], null, false),
            {
              "class": 0,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.6893186330430465, 51.37299802051433],
                  [6.6893186330430465, 51.3714977665279],
                  [6.6989316701524215, 51.3714977665279],
                  [6.6989316701524215, 51.37299802051433]]], null, false),
            {
              "class": 0,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.653281567720959, 51.433668360919405],
                  [6.653281567720959, 51.43077880572404],
                  [6.654569028048107, 51.43077880572404],
                  [6.654569028048107, 51.433668360919405]]], null, false),
            {
              "class": 0,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.697656033663342, 51.44153344638244],
                  [6.697656033663342, 51.44099844948498],
                  [6.699286816744396, 51.44099844948498],
                  [6.699286816744396, 51.44153344638244]]], null, false),
            {
              "class": 0,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.71575897710547, 51.60050903106669],
                  [6.71575897710547, 51.597416775036656],
                  [6.727088627984377, 51.597416775036656],
                  [6.727088627984377, 51.60050903106669]]], null, false),
            {
              "class": 0,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.656035546651182, 51.57801499895643],
                  [6.656035546651182, 51.57721490169409],
                  [6.673030022969542, 51.57721490169409],
                  [6.673030022969542, 51.57801499895643]]], null, false),
            {
              "class": 0,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.685626478548508, 51.56954201072309],
                  [6.685626478548508, 51.559297792758414],
                  [6.6876005843834685, 51.559297792758414],
                  [6.6876005843834685, 51.56954201072309]]], null, false),
            {
              "class": 0,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.643285205400091, 51.56619043878779],
                  [6.643285205400091, 51.56384283630166],
                  [6.649636676347357, 51.56384283630166],
                  [6.649636676347357, 51.56619043878779]]], null, false),
            {
              "class": 0,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.608437945878607, 51.56779100735249],
                  [6.608437945878607, 51.566350498179865],
                  [6.6230291629196225, 51.566350498179865],
                  [6.6230291629196225, 51.56779100735249]]], null, false),
            {
              "class": 0,
              "system:index": "27"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.421657752134298, 51.70203851370616],
                  [6.421657752134298, 51.694484382840606],
                  [6.426292609312032, 51.694484382840606],
                  [6.426292609312032, 51.70203851370616]]], null, false),
            {
              "class": 0,
              "system:index": "28"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.447559760153858, 51.68420288375154],
                  [6.447559760153858, 51.67409097499286],
                  [6.451679633200733, 51.67409097499286],
                  [6.451679633200733, 51.68420288375154]]], null, false),
            {
              "class": 0,
              "system:index": "29"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[8.06440785867854, 51.484984614680634],
                  [8.06440785867854, 51.47857034821499],
                  [8.077282461950025, 51.47857034821499],
                  [8.077282461950025, 51.484984614680634]]], null, false),
            {
              "class": 0,
              "system:index": "30"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[8.11212972147151, 51.488725853505],
                  [8.11212972147151, 51.48541220036856],
                  [8.136677298375806, 51.48541220036856],
                  [8.136677298375806, 51.488725853505]]], null, false),
            {
              "class": 0,
              "system:index": "31"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[8.068012747594556, 51.46990965739259],
                  [8.068012747594556, 51.467236272598974],
                  [8.091702017614088, 51.467236272598974],
                  [8.091702017614088, 51.46990965739259]]], null, false),
            {
              "class": 0,
              "system:index": "32"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[8.089985403844556, 51.485839782047066],
                  [8.089985403844556, 51.48081544409871],
                  [8.10663655740901, 51.48081544409871],
                  [8.10663655740901, 51.485839782047066]]], null, false),
            {
              "class": 0,
              "system:index": "33"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[8.157619986364088, 51.48958095070669],
                  [8.157619986364088, 51.48626735971608],
                  [8.165173086950025, 51.48626735971608],
                  [8.165173086950025, 51.48958095070669]]], null, false),
            {
              "class": 0,
              "system:index": "34"
            })]),
    forest = 
    /* color: #29b915 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[6.649676678804943, 51.43120689869088],
                  [6.649676678804943, 51.42911990360959],
                  [6.651135800509045, 51.42911990360959],
                  [6.651135800509045, 51.43120689869088]]], null, false),
            {
              "class": 1,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.696390090172506, 51.46477823208522],
                  [6.696390090172506, 51.46392266978236],
                  [6.701711592858053, 51.46392266978236],
                  [6.701711592858053, 51.46477823208522]]], null, false),
            {
              "class": 1,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.6476382591178185, 51.473653744479684],
                  [6.6476382591178185, 51.47204986403329],
                  [6.652187285607076, 51.47204986403329],
                  [6.652187285607076, 51.473653744479684]]], null, false),
            {
              "class": 1,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.849520775606104, 51.59471498190409],
                  [6.849520775606104, 51.591355713691065],
                  [6.854584786226221, 51.591355713691065],
                  [6.854584786226221, 51.59471498190409]]], null, false),
            {
              "class": 1,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.856730553438135, 51.59818063316757],
                  [6.856730553438135, 51.59663445219975],
                  [6.864455315401026, 51.59663445219975],
                  [6.864455315401026, 51.59818063316757]]], null, false),
            {
              "class": 1,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.876214119722315, 51.603991670203584],
                  [6.876214119722315, 51.602658929262404],
                  [6.884625527193018, 51.602658929262404],
                  [6.884625527193018, 51.603991670203584]]], null, false),
            {
              "class": 1,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.921693889074096, 51.58837896013581],
                  [6.921693889074096, 51.57989914668792],
                  [6.925556270055542, 51.57989914668792],
                  [6.925556270055542, 51.58837896013581]]], null, false),
            {
              "class": 1,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.501963817578651, 51.560242330536894],
                  [6.501963817578651, 51.55319823812759],
                  [6.517842494946815, 51.55319823812759],
                  [6.517842494946815, 51.560242330536894]]], null, false),
            {
              "class": 1,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.508315288525917, 51.54908868040482],
                  [6.508315288525917, 51.53974739579147],
                  [6.519301616650917, 51.53974739579147],
                  [6.519301616650917, 51.54908868040482]]], null, false),
            {
              "class": 1,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.549971900550897, 51.68772219552907],
                  [6.549971900550897, 51.683571586751675],
                  [6.567824683754022, 51.683571586751675],
                  [6.567824683754022, 51.68772219552907]]], null, false),
            {
              "class": 1,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.493166793386713, 51.729539208616856],
                  [6.493166793386713, 51.72677473507428],
                  [6.500119079153315, 51.72677473507428],
                  [6.500119079153315, 51.729539208616856]]], null, false),
            {
              "class": 1,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.51745687822558, 51.72028819120058],
                  [6.51745687822558, 51.711141646746256],
                  [6.525439132253901, 51.711141646746256],
                  [6.525439132253901, 51.72028819120058]]], null, false),
            {
              "class": 1,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.498156255837513, 51.83948282029446],
                  [6.498156255837513, 51.833436774923555],
                  [6.505108541604114, 51.833436774923555],
                  [6.505108541604114, 51.83948282029446]]], null, false),
            {
              "class": 1,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.032155679454356, 51.7518235259467],
                  [6.032155679454356, 51.7281190471774],
                  [6.0750710236926375, 51.7281190471774],
                  [6.0750710236926375, 51.7518235259467]]], null, false),
            {
              "class": 1,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[5.986837075938731, 51.75979308990638],
                  [5.986837075938731, 51.73970709496663],
                  [6.025460885753184, 51.73970709496663],
                  [6.025460885753184, 51.75979308990638]]], null, false),
            {
              "class": 1,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.070607827891856, 51.77317879130387],
                  [6.070607827891856, 51.75479899434926],
                  [6.080392526378184, 51.75479899434926],
                  [6.080392526378184, 51.77317879130387]]], null, false),
            {
              "class": 1,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.342865744033923, 51.68583725287465],
                  [6.342865744033923, 51.66838011959695],
                  [6.364838400283923, 51.66838011959695],
                  [6.364838400283923, 51.68583725287465]]], null, false),
            {
              "class": 1,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.776670112415144, 51.72388747075094],
                  [6.776670112415144, 51.7126144551695],
                  [6.8322883985479566, 51.7126144551695],
                  [6.8322883985479566, 51.72388747075094]]], null, false),
            {
              "class": 1,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.167002707144818, 51.701389075675436],
                  [7.167002707144818, 51.68478937018618],
                  [7.249400168082318, 51.68478937018618],
                  [7.249400168082318, 51.701389075675436]]], null, false),
            {
              "class": 1,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.904036626832313, 51.713613017155076],
                  [6.904036626832313, 51.70276298458418],
                  [6.922232732789344, 51.70276298458418],
                  [6.922232732789344, 51.713613017155076]]], null, false),
            {
              "class": 1,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.13680945398075, 51.7412581926179],
                  [7.13680945398075, 51.730627433571485],
                  [7.146422491090125, 51.730627433571485],
                  [7.146422491090125, 51.7412581926179]]], null, false),
            {
              "class": 1,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.981284246461219, 51.742746299326086],
                  [6.981284246461219, 51.73211589038644],
                  [6.9915839290784065, 51.73211589038644],
                  [6.9915839290784065, 51.742746299326086]]], null, false),
            {
              "class": 1,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.24996051524279, 51.75872877555209],
                  [7.24996051524279, 51.7515029267603],
                  [7.294935796004509, 51.7515029267603],
                  [7.294935796004509, 51.75872877555209]]], null, false),
            {
              "class": 1,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.899770702757406, 51.85875725117739],
                  [6.899770702757406, 51.85186552491605],
                  [6.914361919798422, 51.85186552491605],
                  [6.914361919798422, 51.85875725117739]]], null, false),
            {
              "class": 1,
              "system:index": "23"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.835100680469615, 51.57480918931235],
                  [6.835100680469615, 51.56221847184879],
                  [6.870291262745005, 51.56221847184879],
                  [6.870291262745005, 51.57480918931235]]], null, false),
            {
              "class": 1,
              "system:index": "24"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.888830691455943, 51.559337054755005],
                  [6.888830691455943, 51.54492723061293],
                  [6.903936892627818, 51.54492723061293],
                  [6.903936892627818, 51.559337054755005]]], null, false),
            {
              "class": 1,
              "system:index": "25"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.982081726956499, 51.85408263621326],
                  [6.982081726956499, 51.84819761677739],
                  [7.002681092190874, 51.84819761677739],
                  [7.002681092190874, 51.85408263621326]]], null, false),
            {
              "class": 1,
              "system:index": "26"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.990321473050249, 51.847508329924636],
                  [6.990321473050249, 51.83626616228699],
                  [7.001994446683062, 51.83626616228699],
                  [7.001994446683062, 51.847508329924636]]], null, false),
            {
              "class": 1,
              "system:index": "27"
            })]),
    greenfields = 
    /* color: #26ff2a */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[6.8682875750540795, 51.642653998262325],
                  [6.8682875750540795, 51.632000056610885],
                  [6.8820204852103295, 51.632000056610885],
                  [6.8820204852103295, 51.642653998262325]]], null, false),
            {
              "class": 2,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.928152203612057, 51.89808583870348],
                  [6.928152203612057, 51.89141202141759],
                  [6.93931019311401, 51.89141202141759],
                  [6.93931019311401, 51.89808583870348]]], null, false),
            {
              "class": 2,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.507038560999373, 51.649405408632816],
                  [7.507038560999373, 51.647035476040514],
                  [7.50935598958824, 51.647035476040514],
                  [7.50935598958824, 51.649405408632816]]], null, false),
            {
              "class": 2,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.498841730249861, 51.65001784297713],
                  [7.498841730249861, 51.64913913025015],
                  [7.504463640345076, 51.64913913025015],
                  [7.504463640345076, 51.65001784297713]]], null, false),
            {
              "class": 2,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.521887270105818, 51.65105629969445],
                  [7.521887270105818, 51.65052376075993],
                  [7.527251688135603, 51.65052376075993],
                  [7.527251688135603, 51.65105629969445]]], null, false),
            {
              "class": 2,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.597694166352689, 51.63778967186967],
                  [7.597694166352689, 51.636884087020604],
                  [7.600708969285428, 51.636884087020604],
                  [7.600708969285428, 51.63778967186967]]], null, false),
            {
              "class": 2,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.594331724633432, 51.639724051882226],
                  [7.594331724633432, 51.63860543333292],
                  [7.596756441582895, 51.63860543333292],
                  [7.596756441582895, 51.639724051882226]]], null, false),
            {
              "class": 2,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.593803376157662, 51.64343718562559],
                  [7.593803376157662, 51.64169280417223],
                  [7.596271008451363, 51.64169280417223],
                  [7.596271008451363, 51.64343718562559]]], null, false),
            {
              "class": 2,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.5864433946207965, 51.641173471539574],
                  [7.5864433946207965, 51.63945563661064],
                  [7.590262860258004, 51.63945563661064],
                  [7.590262860258004, 51.641173471539574]]], null, false),
            {
              "class": 2,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.6023006143168415, 51.640387803174534],
                  [7.6023006143168415, 51.6389229613994],
                  [7.605025738675972, 51.6389229613994],
                  [7.605025738675972, 51.640387803174534]]], null, false),
            {
              "class": 2,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.612373212057326, 51.648023502139246],
                  [7.612373212057326, 51.64538719688223],
                  [7.6140254528105, 51.64538719688223],
                  [7.6140254528105, 51.648023502139246]]], null, false),
            {
              "class": 2,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.626127579885695, 51.649461422210564],
                  [7.626127579885695, 51.6462926119311],
                  [7.6275223285734395, 51.6462926119311],
                  [7.6275223285734395, 51.649461422210564]]], null, false),
            {
              "class": 2,
              "system:index": "11"
            })]),
    urban = 
    /* color: #bf04c2 */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[6.866811718382406, 51.85584164965241],
                  [6.866811718382406, 51.850062899300994],
                  [6.882776226439047, 51.850062899300994],
                  [6.882776226439047, 51.85584164965241]]], null, false),
            {
              "class": 3,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.927153291859343, 51.82878167860561],
                  [6.927153291859343, 51.82358301479333],
                  [6.947924318470671, 51.82358301479333],
                  [6.947924318470671, 51.82878167860561]]], null, false),
            {
              "class": 3,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.84355111901541, 51.8515022984649],
                  [6.84355111901541, 51.835010752399974],
                  [6.8567690450408, 51.835010752399974],
                  [6.8567690450408, 51.8515022984649]]], null, false),
            {
              "class": 3,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.994868305030613, 51.95971727781274],
                  [6.994868305030613, 51.94749797957153],
                  [7.0125494268567845, 51.94749797957153],
                  [7.0125494268567845, 51.95971727781274]]], null, false),
            {
              "class": 3,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.90939128046085, 51.993196884747455],
                  [6.90939128046085, 51.987171502002425],
                  [6.924497481632725, 51.987171502002425],
                  [6.924497481632725, 51.993196884747455]]], null, false),
            {
              "class": 3,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.909515671145763, 52.00441836441855],
                  [6.909515671145763, 51.99786604323919],
                  [6.919214538943614, 51.99786604323919],
                  [6.919214538943614, 52.00441836441855]]], null, false),
            {
              "class": 3,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.002071443999185, 52.088370162423885],
                  [7.002071443999185, 52.07244036300777],
                  [7.023872438872232, 52.07244036300777],
                  [7.023872438872232, 52.088370162423885]]], null, false),
            {
              "class": 3,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.613243079107277, 52.10812373628436],
                  [7.613243079107277, 52.08713826266251],
                  [7.622169470708839, 52.08713826266251],
                  [7.622169470708839, 52.10812373628436]]], null, false),
            {
              "class": 3,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.547052678858637, 52.15862780461604],
                  [7.547052678858637, 52.13281928190736],
                  [7.563017186915277, 52.13281928190736],
                  [7.563017186915277, 52.15862780461604]]], null, false),
            {
              "class": 3,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.508645369307021, 52.18029765794806],
                  [7.508645369307021, 52.165137763869225],
                  [7.534566237226943, 52.165137763869225],
                  [7.534566237226943, 52.18029765794806]]], null, false),
            {
              "class": 3,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.365961071135443, 52.24534200100659],
                  [7.365961071135443, 52.2303094266088],
                  [7.37952231991474, 52.2303094266088],
                  [7.37952231991474, 52.24534200100659]]], null, false),
            {
              "class": 3,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.418651918128196, 52.27880624898977],
                  [7.418651918128196, 52.26494067392097],
                  [7.44302783365554, 52.26494067392097],
                  [7.44302783365554, 52.27880624898977]]], null, false),
            {
              "class": 3,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.441139558509056, 52.30201087465079],
                  [7.441139558509056, 52.28395221475671],
                  [7.455559114173118, 52.28395221475671],
                  [7.455559114173118, 52.30201087465079]]], null, false),
            {
              "class": 3,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.4833749480743705, 52.23751806634794],
                  [7.4833749480743705, 52.22584780969337],
                  [7.489898080398589, 52.22584780969337],
                  [7.489898080398589, 52.23751806634794]]], null, false),
            {
              "class": 3,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.446467752029449, 52.237097569844515],
                  [7.446467752029449, 52.23331292203799],
                  [7.457110757400542, 52.23331292203799],
                  [7.457110757400542, 52.237097569844515]]], null, false),
            {
              "class": 3,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.62273125873246, 52.17792817833679],
                  [7.62273125873246, 52.1729804616801],
                  [7.641099026066445, 52.1729804616801],
                  [7.641099026066445, 52.17792817833679]]], null, false),
            {
              "class": 3,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.720656210191844, 51.583156100756824],
                  [6.720656210191844, 51.5592564938095],
                  [6.754816824205516, 51.5592564938095],
                  [6.754816824205516, 51.583156100756824]]], null, false),
            {
              "class": 3,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.715559800935873, 51.54883919075989],
                  [6.715559800935873, 51.54083244888169],
                  [6.732382615877279, 51.54083244888169],
                  [6.732382615877279, 51.54883919075989]]], null, false),
            {
              "class": 3,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.80877192862142, 51.547451456440456],
                  [6.80877192862142, 51.53592095011631],
                  [6.819929918123373, 51.53592095011631],
                  [6.819929918123373, 51.547451456440456]]], null, false),
            {
              "class": 3,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.833132052936746, 51.52088835581926],
                  [6.833132052936746, 51.51191520223205],
                  [6.875189090290261, 51.51191520223205],
                  [6.875189090290261, 51.52088835581926]]], null, false),
            {
              "class": 3,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.088269686665711, 51.52193219637807],
                  [7.088269686665711, 51.51002129211689],
                  [7.102860903706727, 51.51002129211689],
                  [7.102860903706727, 51.52193219637807]]], null, false),
            {
              "class": 3,
              "system:index": "20"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.0647137107264335, 51.53255458702386],
                  [7.0647137107264335, 51.52598681301044],
                  [7.093638652743035, 51.52598681301044],
                  [7.093638652743035, 51.53255458702386]]], null, false),
            {
              "class": 3,
              "system:index": "21"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.962617813025065, 51.499136330654125],
                  [6.962617813025065, 51.48780736599499],
                  [7.010511337194987, 51.48780736599499],
                  [7.010511337194987, 51.499136330654125]]], null, false),
            {
              "class": 3,
              "system:index": "22"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.072661057853145, 51.68599697137744],
                  [7.072661057853145, 51.67961101844855],
                  [7.108709947013301, 51.67961101844855],
                  [7.108709947013301, 51.68599697137744]]], null, false),
            {
              "class": 3,
              "system:index": "23"
            })]),
    cropland = 
    /* color: #820b0b */
    /* shown: false */
    /* displayProperties: [
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      },
      {
        "type": "rectangle"
      }
    ] */
    ee.FeatureCollection(
        [ee.Feature(
            ee.Geometry.Polygon(
                [[[6.939870369243533, 51.63327866175972],
                  [6.939870369243533, 51.628164024909225],
                  [6.947080147075564, 51.628164024909225],
                  [6.947080147075564, 51.63327866175972]]], null, false),
            {
              "class": 4,
              "system:index": "0"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.1287943281168165, 51.70525580631533],
                  [7.1287943281168165, 51.69259484321662],
                  [7.137720719718379, 51.69259484321662],
                  [7.137720719718379, 51.70525580631533]]], null, false),
            {
              "class": 4,
              "system:index": "1"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.224941521582902, 51.636726861943956],
                  [7.224941521582902, 51.62777654944782],
                  [7.24021938413173, 51.62777654944782],
                  [7.24021938413173, 51.636726861943956]]], null, false),
            {
              "class": 4,
              "system:index": "2"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.1904375848153235, 51.66420606600944],
                  [7.1904375848153235, 51.65451569015134],
                  [7.2137835320809485, 51.65451569015134],
                  [7.2137835320809485, 51.66420606600944]]], null, false),
            {
              "class": 4,
              "system:index": "3"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.257808170743387, 51.623766246421106],
                  [7.257808170743387, 51.61566610689858],
                  [7.29420038265745, 51.61566610689858],
                  [7.29420038265745, 51.623766246421106]]], null, false),
            {
              "class": 4,
              "system:index": "4"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[6.958069885197409, 51.821465221180404],
                  [6.958069885197409, 51.8190247104127],
                  [6.973347747746237, 51.8190247104127],
                  [6.973347747746237, 51.821465221180404]]], null, false),
            {
              "class": 4,
              "system:index": "5"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.013516509953268, 51.8370601459032],
                  [7.013516509953268, 51.83281716371251],
                  [7.0236445311935025, 51.83281716371251],
                  [7.0236445311935025, 51.8370601459032]]], null, false),
            {
              "class": 4,
              "system:index": "6"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.151061627046311, 51.84190517641077],
                  [7.151061627046311, 51.837768718788276],
                  [7.162219616548264, 51.837768718788276],
                  [7.162219616548264, 51.84190517641077]]], null, false),
            {
              "class": 4,
              "system:index": "7"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.915826220721054, 51.4867493202472],
                  [7.915826220721054, 51.484611414404746],
                  [7.921147723406601, 51.484611414404746],
                  [7.921147723406601, 51.4867493202472]]], null, false),
            {
              "class": 4,
              "system:index": "8"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.929473300188827, 51.48824579469651],
                  [7.929473300188827, 51.487203612325494],
                  [7.938828845232773, 51.487203612325494],
                  [7.938828845232773, 51.48824579469651]]], null, false),
            {
              "class": 4,
              "system:index": "9"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.9608882353094135, 51.48408808303824],
                  [7.9608882353094135, 51.48293890404131],
                  [7.969943372943691, 51.48293890404131],
                  [7.969943372943691, 51.48408808303824]]], null, false),
            {
              "class": 4,
              "system:index": "10"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.942882842362766, 51.495676594983976],
                  [7.942882842362766, 51.49300472026368],
                  [7.945457763017063, 51.49300472026368],
                  [7.945457763017063, 51.495676594983976]]], null, false),
            {
              "class": 4,
              "system:index": "11"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.942754096330051, 51.492229847300926],
                  [7.942754096330051, 51.48896989265012],
                  [7.943912810624485, 51.48896989265012],
                  [7.943912810624485, 51.492229847300926]]], null, false),
            {
              "class": 4,
              "system:index": "12"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.94777519160593, 51.49182904577269],
                  [7.94777519160593, 51.48872939495985],
                  [7.950908011735325, 51.48872939495985],
                  [7.950908011735325, 51.49182904577269]]], null, false),
            {
              "class": 4,
              "system:index": "13"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.9386277338525835, 51.52015274270012],
                  [7.9386277338525835, 51.519057881322915],
                  [7.949485315944869, 51.519057881322915],
                  [7.949485315944869, 51.52015274270012]]], null, false),
            {
              "class": 4,
              "system:index": "14"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.941932215358931, 51.51839027000456],
                  [7.941932215358931, 51.51617373024882],
                  [7.949828638698775, 51.51617373024882],
                  [7.949828638698775, 51.51839027000456]]], null, false),
            {
              "class": 4,
              "system:index": "15"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.930945887233931, 51.51793628871822],
                  [7.930945887233931, 51.5135564721471],
                  [7.934550776149947, 51.5135564721471],
                  [7.934550776149947, 51.51793628871822]]], null, false),
            {
              "class": 4,
              "system:index": "16"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.961023790655841, 51.52534806505787],
                  [7.961023790655841, 51.52235750316582],
                  [7.972310526190509, 51.52235750316582],
                  [7.972310526190509, 51.52534806505787]]], null, false),
            {
              "class": 4,
              "system:index": "17"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.960960503827743, 51.53428643720893],
                  [7.960960503827743, 51.526864531328066],
                  [7.966754075299911, 51.526864531328066],
                  [7.966754075299911, 51.53428643720893]]], null, false),
            {
              "class": 4,
              "system:index": "18"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.955596085797958, 51.53078921504048],
                  [7.955596085797958, 51.52689123099967],
                  [7.9595013821236416, 51.52689123099967],
                  [7.9595013821236416, 51.53078921504048]]], null, false),
            {
              "class": 4,
              "system:index": "19"
            }),
        ee.Feature(
            ee.Geometry.Polygon(
                [[[7.9402432270043555, 51.547267874352194],
                  [7.9402432270043555, 51.541262742642296],
                  [7.944320184706992, 51.541262742642296],
                  [7.944320184706992, 51.547267874352194]]], null, false),
            {
              "class": 4,
              "system:index": "20"
            })]);

// 1. IMPORTS & INITIALIZATION
// =========================================

// Import the GAUL shape file as "table" and the training areas as water, forest, greenfields, urban, cropland
// Make sure all FeatureCollections are imported and named correctly!

// Derive and simplify region of interest (ROI) from shape
var roi = table.filterBounds(water)
  .map(function(feature) { 
    return feature.simplify(1000); // Simplification for performance
  });

Map.centerObject(roi);
Map.addLayer(roi, {}, 'Region of Interest');

// =========================================
// 2. PREPARE SENTINEL-2 DATA
// =========================================

// Load and filter Sentinel-2 Level-2A data
var sen2 = ee.ImageCollection('COPERNICUS/S2_SR')
  .filterDate('2023-10-01', '2024-02-29') // Use ISO format
  .filterBounds(roi)
  .filter(ee.Filter.lt('CLOUDY_PIXEL_PERCENTAGE', 10)) // Correct property for S2 SR
  .map(function(img) {
    // Select relevant bands and scale them
    var bands = img.select(['B2','B3','B4','B5','B6','B7','B8']).multiply(0.0001)
      .rename(['B2','B3','B4','B5','B6','B7','B8']);
    // Calculate NDVI (B8 = NIR, B4 = Red)
    var ndvi = bands.normalizedDifference(['B8', 'B4']).rename('NDVI');
    // Calculate NDWI (B3 = Green, B8 = NIR)
    var ndwi = bands.normalizedDifference(['B3', 'B8']).rename('NDWI');
    return bands.addBands([ndvi, ndwi])
      .copyProperties(img, ['system:time_start', 'system:time_end']);
  });

print('Sentinel-2 Collection:', sen2);

// Percentile reduction for Sentinel-2 (90, 70, 55)
var sen2_perc = sen2.reduce(ee.Reducer.percentile([90, 70, 55]));
Map.addLayer(sen2_perc.clip(roi), {}, 'Sentinel-2 Percentiles', false);

// =========================================
// 3. PREPARE SENTINEL-1 DATA
// =========================================

// Load and filter Sentinel-1 data
var sen1 = ee.ImageCollection('COPERNICUS/S1_GRD')
  .filterDate('2023-01-01', '2024-01-01')
  .filterBounds(roi)
  .filter(ee.Filter.listContains('transmitterReceiverPolarisation', 'VV'))
  .filter(ee.Filter.eq('instrumentMode', 'IW'))
  .select(['VV', 'VH'])
  .filter(ee.Filter.eq('orbitProperties_pass', 'DESCENDING'));

// Percentile reduction for Sentinel-1 (75, 50)
var sen1_perc = sen1.reduce(ee.Reducer.percentile([75, 50]));
Map.addLayer(sen1_perc.clip(roi), {}, 'Sentinel-1 Percentiles', false);

// =========================================
// 4. CREATE FEATURE STACK
// =========================================

// Combine Sentinel-2 and Sentinel-1 into a single dataset
var dataset = sen2_perc.addBands(sen1_perc);

// =========================================
// 5. TRAINING AND VALIDATION DATA
// =========================================

// Merge training areas
var samples = water.merge(forest).merge(greenfields).merge(urban).merge(cropland);

// Add random number for splitting
samples = samples.randomColumn('random');

// Split: 70% training, 30% validation
var split = 0.7;
var trainingSet = samples.filter(ee.Filter.lt('random', split));
var validationSet = samples.filter(ee.Filter.gte('random', split));

// Extract training data
var training_data = dataset.sampleRegions({
  collection: trainingSet,
  properties: ['class'],
  scale: 30,
  geometries: false // Performance: do not include geometries
});

// =========================================
// 6. TRAIN MODEL
// =========================================

var model = ee.Classifier.smileRandomForest(80).train({
  features: training_data,
  classProperty: 'class',
  inputProperties: dataset.bandNames()
});

// =========================================
// 7. CLASSIFICATION & VALIDATION
// =========================================

// Classify the entire dataset
var classified = dataset.classify(model).rename('classified_map');
Map.addLayer(classified.clip(roi), 
  {min: 0, max: 4, palette: ['blue', 'green', 'red', 'black', 'orange']}, 
  'Classified Map', false);

// Extract validation data
var validation_data = dataset.sampleRegions({
  collection: validationSet,
  properties: ['class'],
  scale: 30,
  geometries: false
});
var validated = validation_data.classify(model);

// confusion matrix and labels 
var confusionMatrix = validated.errorMatrix('class', 'classification');
var matrix = confusionMatrix.array();
var labels = confusionMatrix.order();

// Get both labels and matrix as a single evaluated object
labels.evaluate(function(classLabels) {
  matrix.evaluate(function(mat) {
    print('Classes:', classLabels);
    var f1_sum = 0;
    for (var i = 0; i < classLabels.length; i++) {
      var TP = mat[i][i];
      var FP = 0;
      var FN = 0;
      for (var j = 0; j < classLabels.length; j++) {
        if (j !== i) {
          FP += mat[j][i];
          FN += mat[i][j];
        }
      }
      var precision = TP / (TP + FP);
      var recall = TP / (TP + FN);
      var f1 = (precision + recall > 0) ? 2 * precision * recall / (precision + recall) : 0;
      print('Class ' + classLabels[i] + ': F1-Score =', f1);
      f1_sum += f1;
    }
    var macro_f1 = f1_sum / classLabels.length;
    print('Macro-F1-Score:', macro_f1);
  });
});


// remaining prints as usual
print('Confusion Matrix:', confusionMatrix);
print('Overall Accuracy:', confusionMatrix.accuracy());
print('Kappa Index:', confusionMatrix.kappa());

// =========================================
// 8. ADD LEGEND
// =========================================

var legend = ui.Panel({
  style: {position: 'bottom-right', padding: '8px 15px'}
});
legend.add(ui.Label({
  value: 'Land Cover Classes',
  style: {fontWeight: 'bold', fontSize: '16px', margin: '0 0 4px 0'}
}));
function makeRow(color, name) {
  return ui.Panel([
    ui.Label({style: {backgroundColor: color, padding: '8px', margin: '0 0 4px 0'}}),
    ui.Label({value: name, style: {margin: '0 0 4px 6px'}})
  ], ui.Panel.Layout.Flow('horizontal'));
}
legend.add(makeRow('blue', 'Water'));
legend.add(makeRow('green', 'Forest'));
legend.add(makeRow('red', 'Grassland'));
legend.add(makeRow('black', 'Urban'));
legend.add(makeRow('orange', 'Cropland'));
Map.add(legend);

// =========================================
// 9. EXPORT
// =========================================

Export.image.toDrive({
  image: classified.clip(geometry),
  description: 'LandCoverMap_2023',
  region: geometry,
  scale: 30,
  folder: 'test',
  crs: 'EPSG:4326',
  maxPixels: 1e13
});
